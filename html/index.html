<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">

  <meta name="title" content="SourceBin">
  <meta name="description" content="Free text/code sharing site supporting 450+ different languages!">

  <meta name="og:title" content="SourceBin">
  <meta name="og:description" content="Free text/code sharing site supporting 450+ different languages!">
  <meta name="theme-color" content="<% color=#FF5555 %>">
  <!-- <meta name="og:url" content=""> -->
  <!-- <meta name="og:image" content=""> -->

  <title>SourceBin | Free Code Sharing!</title>

  <!-- CSS -->
  <link rel="stylesheet" href="./assets/css/master.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:Regular,Bold">
</head>

<body>
  <div id="linkbox">
    <div id="content">
      <h1>Copy the link to share the bin!</h1>
      <textarea readonly id="link"></textarea>
    </div>
  </div>

  <nav>
    <ul>
      <li class="box click" id="save">Save</li>
      <li class="box click">New</li>
      <li class="box click" id="lang">Language - None</li>
      <li class="box click" id="theme">Theme - None</li>
    </ul>
  </nav>
  <pre id="editor"><% code=Loading... %></pre>

  <!-- Scripts -->
  <script src="./assets/editor/ace.js" type="text/javascript" charset="utf-8"></script>
  <script src="./assets/javascript/index.js" type="text/javascript" charset="utf-8"></script>
  <script src="./assets/javascript/selector.js" type="text/javascript" charset="utf-8"></script>
  <script src="./assets/javascript/popup.js" type="text/javascript" charset="utf-8"></script>
  <script>
    const key = <% key=undefined %>;
    const language = <% language=undefined %> || JSON.parse(localStorage.getItem('language'));
    const allowSave = <% allowSave=true %>;
    const languages = <% languages %>;
    const themes = <% themes %>;

    const bin = new Bin({
      key,
      language,
      allowSave
    });

    const languageSelector = new Selector('Select a language', languages, function(event) {
      const name = event.target.innerHTML;
      return _request('get', `/language?search=${encodeURIComponent(name)}`).then(response => {
        if (!response) return;
        localStorage.setItem('language', JSON.stringify(response));
        bin.setLanguage(response);
        bin.setURL();
        this.hide();
      });
    });

    const themeSelector = new Selector('Select a theme', themes, function(event) {
      const name = event.target.innerHTML;
      return _request('get', `/theme?search=${encodeURIComponent(name)}`).then(response => {
        if (!response) return;
        bin.setTheme(response);
        this.hide();
      });
    });

    window.addEventListener('load', () => {
      document.getElementById('editor').setAttribute('style', 'display:inherit');
      return bin.focus();
    });

    document.getElementById('linkbox').addEventListener('click', event => {
      if (event.target === document.getElementById('linkbox')) return document.getElementById('linkbox').setAttribute('style', 'display:none');
    });

    for (const element of document.getElementsByClassName('click')) {
      element.addEventListener('click', event => {
        const element = event.target;
        const name = element.innerHTML;
        if (bin.isDisabled(name)) return;
        if (name === 'Save') return bin.save();
        if (name === 'New') return window.location.href = origin;
        if (name.startsWith('Language')) return languageSelector.show();
        if (name.startsWith('Theme')) return themeSelector.show();
      });
    }

    document.addEventListener('keydown', event => {
      const ctrl = event.metaKey || event.ctrlKey;
      if (event.keyCode === 83 && ctrl) {
        bin.save();
        return event.preventDefault();
      } else if (event.keyCode === 27) {
        languageSelector.hide();
        themeSelector.hide();
        bin.LinkBox.hide();
        return event.preventDefault();
      }
    });

    function _request(method, url, body = null) {
      return new Promise(resolve => {
        const xhttp = new XMLHttpRequest();
        xhttp.addEventListener('readystatechange', () => {
          if (xhttp.readyState !== 4) return;
          const response = JSON.parse(xhttp.response);
          if (xhttp.status === 200) resolve(response);
          else {
            const error = response.error ? response.error : response;
            return new Popup(`(⊙.☉)7 ${error}`, null, null, true, 10000);
          }
        });
        xhttp.open(method.toUpperCase(), url, true);
        xhttp.send(body);
      });
    }

  </script>
</body>

</html>
