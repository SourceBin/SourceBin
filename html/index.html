<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">

  <meta name="title" content="SourceBin">
  <meta name="description" content="Free text/code sharing site supporting 150+ different languages!">

  <meta name="og:title" content="SourceBin">
  <meta name="og:description" content="Free text/code sharing site supporting 150+ different languages!">
  <meta name="theme-color" content="#<% color=FF5555 %>">
  <!-- <meta name="og:url" content=""> -->
  <!-- <meta name="og:image" content=""> -->

  <title>SourceBin | Free Code Sharing!</title>

  <!-- CSS -->
  <style>
    :root {
      --nav-size: 20px;
      --language-border: 1px solid #181a1f;
      --language-background: #21252b;
      --language-color: #d7dae0;
    }

    body,
    html {
      margin: 0;
      padding: 0;
      background-color: #282a2e;
      color: white;
    }

    #language {
      z-index: 10;
      position: absolute;
      width: 100vw;
      height: 100vh;

      display: none;
      background-color: rgba(255, 255, 255, 0.1);
    }

    #language #content {
      background-color: var(--language-background);
      width: calc(70vw - 1px);
      height: calc(70vh - 1px);
      margin: calc(15vh - 1px) calc(15vw - 1px);
      border: var(--language-border);

      color: var(--language-color);
      user-select: none;
      cursor: default;
      overflow: hidden;
    }

    #language #content #head {
      height: 40px;
      line-height: 40px;
      display: block;
      font-family: 'Raleway:Bold', sans-serif;
      font-size: 30px;
      padding: 20px 50px;
      border-bottom: var(--language-border);
    }

    #language #content #head input {
      margin: 13px 0;
      float: right;
      outline: none;
      border: none;
      border-bottom: 1px solid var(--language-color);
      color: var(--language-color);
      background: transparent;
    }

    #language #content #options {
      height: calc(70vh - 81px);
      overflow-y: auto;
    }

    #language #content #options .box {
      font-family: 'Raleway', sans-serif;
      font-size: 20px;
      padding: 10px 50px;
      border-bottom: var(--language-border);
      cursor: pointer;
    }

    nav {
      margin: 0;
      padding: 0;

      width: 100vw;
      height: var(--nav-size);

      line-height: var(--nav-size);
      font-size: calc(var(--nav-size) * 0.65);
      font-family: 'Raleway', sans-serif;
      color: #0D0D0D;
      background-color: #C0C0C0;

      display: flex;
      flex-direction: row;
    }

    nav .box {
      padding: 0 15px;
      cursor: pointer;
      user-select: none;
      transition-duration: 0.2s;
    }

    nav .box:hover {
      background-color: #A7A7A7;
    }

    nav .box.disabled {
      color: #262626;
      cursor: not-allowed;
    }

    nav .box.disabled:hover {
      background-color: #B4B4B4;
    }

    #editor {
      margin: 0;
      padding: 0;
      position: relative;
      width: 100vw;
      height: calc(100vh - var(--nav-size));
    }
  </style>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:Regular,Bold">
</head>

<body>
  <div id="language">
    <div id="content">
      <div id="head">
        Select a language
        <input type="text" id="search" placeholder="Search" />
      </div>
      <div id="options"></div>
    </div>
  </div>

  <nav>
    <div class="box click <% saving=enabled %>" id="save">Save</div>
    <div class="box click">Edit</div>
    <div class="box click">New</div>
    <div class="box click">Language</div>
    <div class="box" id="lang">None</div>
  </nav>
  <pre id="editor"><% code=Loading... %></pre>

  <!-- Scripts -->
  <script src="./editor/ace.js" type="text/javascript" charset="utf-8"></script>
  <script>
    const origin = window.location.origin;
    let _key = <% key=undefined %>;
    let language = <% language=undefined %>;
    const languages = <% languages %>;

    const editor = ace.edit('editor');
    editor.setTheme('ace/theme/material');
    editor.setReadOnly(<% readOnly=false %>);
    editor.setFontSize(15);
    editor.focus();
    if (editor.getValue() === 'Loading...') editor.setValue('', -1);

    setURL();
    setLanguage();

    for (const element of document.getElementsByClassName('click')) {
      element.addEventListener('click', event => {
        const element = event.target;
        const disabled = element.classList.contains('disabled');
        if (disabled) return;
        const name = element.innerHTML;
        if (name === 'Save') {
          disableSave();
          editor.setReadOnly(true);
          languageSelector(true);
          return _request('post', '/', editor.getValue())
            .then(response => {
              if (response) _key = response.key;
            });
        }
        if (name === 'Edit') return editor.setReadOnly(false);
        if (name === 'New') return window.location.href = origin;
        if (name === 'Language') return languageSelector(true);
      });
    }

    function setURL() {
      let url = origin;
      if (_key) {
        url += '/' + _key;
        if (language) url += '.' + language.extension;
      }
      return window.history.pushState({}, '', url);
    }

    function setLanguage(lang) {
      if (lang) language = lang;
      if (!language) return;
      editor.session.setMode(`ace/mode/${language.ace}`);
      return document.getElementById('lang').innerHTML = language.name;
    }

    const input = document.getElementById('search');
    input.addEventListener('input', () => addLanguages());

    function addLanguages() {
      const search = input.value.toLowerCase();
      const options = document.getElementById('options');
      options.innerHTML = '';
      const language = languages.filter(lang => lang.toLowerCase().includes(search));
      for (const lang of language) {
        const language = document.createElement('div');
        language.className = 'box';
        language.innerHTML = lang;
        options.appendChild(language);
        language.addEventListener('click', event => {
          const name = event.target.innerHTML;
          return _request('get', `/language?search=${encodeURIComponent(name)}`).then(response => {
            if (!response) return;
            setLanguage(response);
            setURL();
            return languageSelector(false);
          });
        });
      }
    }

    function languageSelector(open) {
      addLanguages();
      const language = document.getElementById('language');
      language.setAttribute('style', `display:${open ? 'inherit' : 'none'}`);
      const input = document.getElementById('search');
      return input.focus();
    }

    function disableSave() {
      const save = document.getElementById('save');
      return save.className = save.className.replace('enabled', 'disabled');
    }

    function _request(method, url, body = null) {
      return new Promise(resolve => {
        const xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
          if (this.readyState === 4 && this.status === 200) {
            resolve(JSON.parse(this.response));
          }
        };
        xhttp.open(method.toUpperCase(), url, true);
        xhttp.send(body);
      });
    }
  </script>
</body>

</html>